// 預設資料或從 localStorage 讀取
let stockData = JSON.parse(localStorage.getItem('myStocks')) || [
    { 
        id: Date.now().toString(),
        symbol: '2330', 
        name: '台積電', 
        fields: [
            { date: '', number: '' },
            { date: '', number: '' },
            { date: '', number: '' }
        ]
    }
];

// 儲存資料到瀏覽器
function saveData() {
    localStorage.setItem('myStocks', JSON.stringify(stockData));
}

// 核心：真實抓取即時股價與漲幅的非同步函式
async function fetchRealPrice(symbol) {
    try {
        // 台股在 Yahoo API 的格式通常為 股號.TW (上市) 或 股號.TWO (上櫃)
        // 為簡化示範，若您未輸入後綴，程式自動補上 .TW
        const yfSymbol = symbol.includes('.') ? symbol : `${symbol}.TW`;
        
        // 使用免費的 CORS 代理服務來繞過瀏覽器跨域限制，取得 Yahoo Finance 資料
        const proxyUrl = 'https://api.allorigins.win/raw?url=';
        const targetUrl = encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${yfSymbol}?interval=1d&range=1d`);
        
        const response = await fetch(proxyUrl + targetUrl);
        if (!response.ok) throw new Error('API 請求失敗');
        
        const data = await response.json();
        
        // 解析回傳的 JSON 資料結構
        const meta = data.chart.result[0].meta;
        const currentPrice = meta.regularMarketPrice.toFixed(2);
        const previousClose = meta.chartPreviousClose;
        
        // 計算漲跌幅 %
        const changeNum = (((currentPrice - previousClose) / previousClose) * 100).toFixed(2);
        
        return { price: currentPrice, change: changeNum };
    } catch (error) {
        console.error(`抓取 ${symbol} 股價發生錯誤:`, error);
        return { price: '---', change: '---' }; // 抓取失敗時顯示橫線
    }
}

// 渲染畫面主程式
async function renderList() {
    const listContainer = document.getElementById('stockList');
    listContainer.innerHTML = '';

    // 第一階段：先畫出所有股票卡片的骨架與自訂欄位，股價先顯示「載入中...」
    stockData.forEach((stock) => {
        const cardHtml = `
            <div class="stock-card" id="card-${stock.id}">
                <button class="delete-btn" onclick="deleteStock('${stock.id}')">✕</button>
                
                <div class="stock-header">
                    <div class="stock-name-group">
                        <span class="symbol">${stock.symbol}</span>
                        <span class="name">${stock.name}</span>
                    </div>
                    <div class="stock-price-group">
                        <div class="price" id="price-${stock.id}">載入中...</div>
                        <div class="change" id="change-${stock.id}"></div>
                    </div>
                </div>

                <div class="custom-fields">
                    ${[0, 1, 2].map(i => `
                        <div class="field-row">
                            <span class="field-label">${i+1}.</span>
                            <input type="date" 
                                   value="${stock.fields[i]?.date || ''}" 
                                   onchange="updateField('${stock.id}', ${i}, 'date', this.value)">
                            <input type="number" 
                                   placeholder="輸入數值" 
                                   value="${stock.fields[i]?.number || ''}" 
                                   onchange="updateField('${stock.id}', ${i}, 'number', this.value)">
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        listContainer.innerHTML += cardHtml;
    });

    // 第二階段：非同步去網路抓取每一檔真實股價，抓到後自動更新畫面上的數字
    for (const stock of stockData) {
        const data = await fetchRealPrice(stock.symbol);
        
        const priceElement = document.getElementById(`price-${stock.id}`);
        const changeElement = document.getElementById(`change-${stock.id}`);
        
        if (data.price !== '---') {
            const isUp = parseFloat(data.change) > 0;
            const priceClass = isUp ? 'is-up' : 'is-down';
            const changeSign = isUp ? '+' : '';

            priceElement.innerText = data.price;
            priceElement.className = `price ${priceClass}`;
            
            changeElement.innerText = `${changeSign}${data.change}%`;
            changeElement.className = `change ${priceClass}`;
        } else {
            priceElement.innerText = '查無報價';
            priceElement.style.fontSize = '14px';
            priceElement.style.color = '#999';
        }
    }
}

// 更新自訂欄位資料並自動存檔
function updateField(stockId, fieldIndex, fieldType, value) {
    const stock = stockData.find(s => s.id === stockId);
    if (stock) {
        stock.fields[fieldIndex][fieldType] = value;
        saveData();
    }
}

// 刪除股票
function deleteStock(stockId) {
    if(confirm('確定要移除這檔股票嗎？')) {
        stockData = stockData.filter(s => s.id !== stockId);
        saveData();
        renderList();
    }
}

// Modal 控制與新增功能
function openModal() {
    document.getElementById('addModal').style.display = 'flex';
    document.getElementById('newSymbol').value = '';
    document.getElementById('newName').value = '';
}

function closeModal() {
    document.getElementById('addModal').style.display = 'none';
}

function addNewStock() {
    const symbol = document.getElementById('newSymbol').value.trim();
    const name = document.getElementById('newName').value.trim();

    if (!symbol || !name) {
        alert('請完整填寫股號與股名！');
        return;
    }

    const newStock = {
        id: Date.now().toString(),
        symbol: symbol,
        name: name,
        fields: [
            { date: '', number: '' },
            { date: '', number: '' },
            { date: '', number: '' }
        ]
    };

    stockData.unshift(newStock); 
    saveData();
    renderList();
    closeModal();
}

// 網頁載入時立刻執行渲染與抓取
window.onload = renderList;
